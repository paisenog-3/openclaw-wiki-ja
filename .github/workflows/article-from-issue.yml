name: è¨˜äº‹æŠ•ç¨¿ã®è‡ªå‹•PRä½œæˆ

on:
  issues:
    types: [labeled]

jobs:
  create-article-pr:
    if: contains(github.event.issue.labels.*.name, 'article-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            // Parse form fields
            const getField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*\\n([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const title = getField('è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«');
            const category = getField('ã‚«ãƒ†ã‚´ãƒª');
            const content = getField('è¨˜äº‹ã®å†…å®¹');
            const notes = getField('è£œè¶³ãƒ»ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰');
            
            // Map category to directory
            const categoryMap = {
              'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆsetupï¼‰': 'setup',
              'ã‚¹ã‚­ãƒ«ãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆskillsï¼‰': 'wiki-notes',
              'é‹ç”¨Tipsï¼ˆtipsï¼‰': 'wiki-notes',
              'ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆtroubleshootingï¼‰': 'wiki-notes',
              'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆreleasesï¼‰': 'releases',
              'ãã®ä»–': 'wiki-notes'
            };
            const dir = categoryMap[category] || 'wiki-notes';
            
            // Generate slug from issue number
            const slug = `community-${context.payload.issue.number}`;
            
            core.setOutput('title', title);
            core.setOutput('category', category);
            core.setOutput('content', content);
            core.setOutput('notes', notes);
            core.setOutput('dir', dir);
            core.setOutput('slug', slug);
            core.setOutput('issue_number', context.payload.issue.number);
            core.setOutput('author', context.payload.issue.user.login);

      - name: Create article file
        run: |
          DIR="content/${{ steps.parse.outputs.dir }}"
          FILE="${DIR}/${{ steps.parse.outputs.slug }}.md"
          mkdir -p "$DIR"
          
          cat > "$FILE" << 'FRONTMATTER'
          ---
          title: "${{ steps.parse.outputs.title }}"
          ---
          FRONTMATTER
          
          # Fix indentation from heredoc
          sed -i 's/^          //' "$FILE"
          
          # Append content
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          
          # Add notes as comment if present
          if [ -n "$NOTES" ]; then
            echo "" >> "$FILE"
            echo "---" >> "$FILE"
            echo "" >> "$FILE"
            echo "> æŠ•ç¨¿è€…ãƒ¡ãƒ¢: $NOTES" >> "$FILE"
          fi
        env:
          CONTENT: ${{ steps.parse.outputs.content }}
          NOTES: ${{ steps.parse.outputs.notes }}

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: article/issue-${{ steps.parse.outputs.issue_number }}
          title: "ğŸ“ è¨˜äº‹æŠ•ç¨¿: ${{ steps.parse.outputs.title }}"
          body: |
            ## æŠ•ç¨¿è¨˜äº‹ã®è‡ªå‹•PR

            - **æŠ•ç¨¿è€…**: @${{ steps.parse.outputs.author }}
            - **ã‚«ãƒ†ã‚´ãƒª**: ${{ steps.parse.outputs.category }}
            - **å…ƒIssue**: #${{ steps.parse.outputs.issue_number }}

            ---
            å†…å®¹ã‚’ç¢ºèªã—ã¦ã€å•é¡Œãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
            ãƒãƒ¼ã‚¸å¾Œã€Issueã¯è‡ªå‹•ã§ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚
          labels: article-submission
          commit-message: "docs: ${{ steps.parse.outputs.title }} (#${{ steps.parse.outputs.issue_number }})"

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸŒ¸ è¨˜äº‹ã®PRã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸï¼ç®¡ç†è€…ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€Wikiã«æ²è¼‰ã•ã‚Œã¾ã™ã€‚\n\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`
            });
