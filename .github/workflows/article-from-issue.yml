name: è¨˜äº‹æŠ•ç¨¿ã®è‡ªå‹•å…¬é–‹

on:
  issues:
    types: [opened]

jobs:
  publish-article:
    if: contains(github.event.issue.labels.*.name, 'article-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            const getField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*\\n([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã¯Issueã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å–å¾—ï¼ˆ[ãƒãƒ¼ãƒˆæŠ•ç¨¿] ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼‰
            const title = context.payload.issue.title.replace(/^\[ãƒãƒ¼ãƒˆæŠ•ç¨¿\]\s*/, '').trim();
            const category = getField('ã‚«ãƒ†ã‚´ãƒª');
            const authorName = getField('æŠ•ç¨¿è€…åï¼ˆä»»æ„ â€” ç©ºæ¬„ã®å ´åˆã¯ã€ŒåŒ¿åã€ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰');
            const authorLink = getField('SNS / Webã‚µã‚¤ãƒˆï¼ˆä»»æ„ â€” ãƒãƒ¼ãƒˆã«æŠ•ç¨¿è€…ãƒªãƒ³ã‚¯ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰');
            const content = getField('ãƒãƒ¼ãƒˆã®å†…å®¹');
            const notes = getField('è£œè¶³ãƒ»ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰');
            
            const categoryMap = {
              'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆsetupï¼‰': 'wiki-notes',
              'ã‚¹ã‚­ãƒ«ãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆskillsï¼‰': 'wiki-notes',
              'é‹ç”¨Tipsï¼ˆtipsï¼‰': 'wiki-notes',
              'ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆtroubleshootingï¼‰': 'wiki-notes',
              'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆreleasesï¼‰': 'releases',
              'ãã®ä»–': 'wiki-notes'
            };
            const dir = categoryMap[category] || 'wiki-notes';
            const slug = `community-${context.payload.issue.number}`;
            
            const noResponse = '_No response_';
            const displayName = (authorName && authorName !== noResponse) 
              ? authorName 
              : 'åŒ¿å';
            const link = (authorLink && authorLink !== noResponse) ? authorLink : '';
            
            core.setOutput('title', title);
            core.setOutput('content', content);
            core.setOutput('notes', notes);
            core.setOutput('dir', dir);
            core.setOutput('slug', slug);
            core.setOutput('issue_number', context.payload.issue.number);
            core.setOutput('github_user', context.payload.issue.user.login);
            core.setOutput('display_name', displayName);
            core.setOutput('author_link', link);

      - name: Create article file
        run: |
          DIR="content/${{ steps.parse.outputs.dir }}"
          FILE="${DIR}/${{ steps.parse.outputs.slug }}.md"
          mkdir -p "$DIR"
          
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          DATE_JP=$(TZ=Asia/Tokyo date +%Yå¹´%mæœˆ%dæ—¥)
          
          # Build contributor YAML
          if [ -n "$AUTHOR_LINK" ]; then
            CONTRIB_YAML="  - name: \"$DISPLAY_NAME\"
    link: \"$AUTHOR_LINK\"
    github: \"$GITHUB_USER\"
    percentage: 100
    date: $(date -u +%Y-%m-%d)"
          else
            CONTRIB_YAML="  - name: \"$DISPLAY_NAME\"
    github: \"$GITHUB_USER\"
    percentage: 100
    date: $(date -u +%Y-%m-%d)"
          fi
          
          # Build frontmatter + content
          {
            echo "---"
            echo "title: \"$TITLE\""
            echo "date: $DATE"
            echo "source_issue: $ISSUE_NUM"
            echo "community: true"
            echo "contributors:"
            echo "$CONTRIB_YAML"
            echo "---"
            echo ""
            echo "$CONTENT"
          } > "$FILE"
          
          # Add notes if present
          if [ -n "$NOTES" ] && [ "$NOTES" != "_No response_" ]; then
            echo "" >> "$FILE"
            echo "---" >> "$FILE"
            echo "" >> "$FILE"
            echo "> æŠ•ç¨¿è€…ãƒ¡ãƒ¢: $NOTES" >> "$FILE"
          fi
          
          # Add contributor footer
          echo "" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          if [ -n "$AUTHOR_LINK" ]; then
            echo "> ğŸ“ [$DISPLAY_NAME]($AUTHOR_LINK) ã•ã‚“ãŒæŠ•ç¨¿ï¼ˆ${DATE_JP}ï¼‰â€” å¯„ä¸ 100%" >> "$FILE"
          else
            echo "> ğŸ“ $DISPLAY_NAME ã•ã‚“ãŒæŠ•ç¨¿ï¼ˆ${DATE_JP}ï¼‰â€” å¯„ä¸ 100%" >> "$FILE"
          fi
        env:
          TITLE: ${{ steps.parse.outputs.title }}
          CONTENT: ${{ steps.parse.outputs.content }}
          NOTES: ${{ steps.parse.outputs.notes }}
          DISPLAY_NAME: ${{ steps.parse.outputs.display_name }}
          AUTHOR_LINK: ${{ steps.parse.outputs.author_link }}
          GITHUB_USER: ${{ steps.parse.outputs.github_user }}
          ISSUE_NUM: ${{ steps.parse.outputs.issue_number }}

      - name: Commit and push
        run: |
          git config user.name "wiki-bot"
          git config user.email "wiki-bot@users.noreply.github.com"
          git add -A
          git commit -m "docs: ${{ steps.parse.outputs.title }} (closes #${{ steps.parse.outputs.issue_number }})"
          git push

      - name: Close issue with comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸŒ¸ è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼\n\nğŸ‘‰ [Wikiã§ç¢ºèªã™ã‚‹](https://paisenog-3.github.io/openclaw-wiki-ja/${{ steps.parse.outputs.dir }}/${{ steps.parse.outputs.slug }}/)\n\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });
