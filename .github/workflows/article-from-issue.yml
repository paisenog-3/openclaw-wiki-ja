name: è¨˜äº‹æŠ•ç¨¿ã®è‡ªå‹•å…¬é–‹

on:
  issues:
    types: [opened]

jobs:
  publish-article:
    if: contains(github.event.issue.labels.*.name, 'article-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body;
            
            const getField = (label) => {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*\\n([\\s\\S]*?)(?=\\n### |$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const title = getField('è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«');
            const category = getField('ã‚«ãƒ†ã‚´ãƒª');
            const content = getField('è¨˜äº‹ã®å†…å®¹');
            const notes = getField('è£œè¶³ãƒ»ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰');
            
            const categoryMap = {
              'ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆsetupï¼‰': 'setup',
              'ã‚¹ã‚­ãƒ«ãƒ»ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ï¼ˆskillsï¼‰': 'wiki-notes',
              'é‹ç”¨Tipsï¼ˆtipsï¼‰': 'wiki-notes',
              'ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆtroubleshootingï¼‰': 'wiki-notes',
              'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆï¼ˆreleasesï¼‰': 'releases',
              'ãã®ä»–': 'wiki-notes'
            };
            const dir = categoryMap[category] || 'wiki-notes';
            const slug = `community-${context.payload.issue.number}`;
            
            core.setOutput('title', title);
            core.setOutput('content', content);
            core.setOutput('notes', notes);
            core.setOutput('dir', dir);
            core.setOutput('slug', slug);
            core.setOutput('issue_number', context.payload.issue.number);
            core.setOutput('author', context.payload.issue.user.login);

      - name: Create article file
        run: |
          DIR="content/${{ steps.parse.outputs.dir }}"
          FILE="${DIR}/${{ steps.parse.outputs.slug }}.md"
          mkdir -p "$DIR"
          
          {
            echo "---"
            echo "title: \"$TITLE\""
            echo "date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "author: $AUTHOR"
            echo "source_issue: $ISSUE_NUM"
            echo "---"
            echo ""
            echo "$CONTENT"
          } > "$FILE"
          
          if [ -n "$NOTES" ] && [ "$NOTES" != "_No response_" ]; then
            echo "" >> "$FILE"
            echo "---" >> "$FILE"
            echo "" >> "$FILE"
            echo "> æŠ•ç¨¿è€…ãƒ¡ãƒ¢: $NOTES" >> "$FILE"
          fi
        env:
          TITLE: ${{ steps.parse.outputs.title }}
          CONTENT: ${{ steps.parse.outputs.content }}
          NOTES: ${{ steps.parse.outputs.notes }}
          AUTHOR: ${{ steps.parse.outputs.author }}
          ISSUE_NUM: ${{ steps.parse.outputs.issue_number }}

      - name: Commit and push
        run: |
          git config user.name "wiki-bot"
          git config user.email "wiki-bot@users.noreply.github.com"
          git add -A
          git commit -m "docs: ${{ steps.parse.outputs.title }} (closes #${{ steps.parse.outputs.issue_number }})"
          git push

      - name: Close issue with comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸŒ¸ è¨˜äº‹ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼\n\nğŸ‘‰ [Wikiã§ç¢ºèªã™ã‚‹](https://paisenog-3.github.io/openclaw-wiki-ja/${{ steps.parse.outputs.dir }}/${{ steps.parse.outputs.slug }}/)\n\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });
